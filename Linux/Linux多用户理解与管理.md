# Linux多用户理解与管理

## 用户与组的概念

### 理解linux多用户，多任务的特性

Linux是一个真实的、完整的多用户多任务操作系统，多用户多任务就是可以在系统上建立多个用户，而多个用户可以在同一时间内登录同一个系统执行各自不同的任务，而互不影响，例如某台linux服务器上有4个用户，分别是root、www、ftp和mysql，在同一时间内，root用户可能在查看系统日志，管理维护系统，www用户可能在修改自己的网页程序，ftp用户可能在上传软件到服务器，mysql用户可能在执行自己的SQL查询，每个用户互不干扰，有条不紊的进行着自己的工作，而每个用户之间不能越权访问，比如www用户不能执行mysql用户的SQL查询操作，ftp用户也不能修改www用户的网页程序，因此可知，不同用户具有不同的权限，每个用户是在权限允许的范围内完成不同的任务，linux正是通过这种权限的划分与管理，实现了多用户多任务的运行机制。

### linux下用户的角色分类

在linux下用户是根据角色定义的，具体分为三种角色：

**超级用户**：拥有对系统的最高管理权限，默认是root用户。UID 和 group ID都为 0.

**普通用户**：只能对自己目录下的文件进行访问和修改，具有登录系统的权限，例如上面提到的www用户、ftp用户等。

>
- 可登录系统, 拥有有限的权限, 可使用sudo获得root权限
- 有自己的`/home`目录，以及拥有自己的默认shell 
- UID从1000开始，像aws的ec2的ec2-user用户为1000

**虚拟用户(程序用户)**：也叫“伪”用户，这类用户最大的特点是不能登录系统，它们的存在主要是方便系统管理，满足相应的系统进程对文件属主的要求。例如系统默认的bin、adm、nobody用户等，一般运行的web服务，默认就是使用的nobody用户，但是nobody用户是不能登录系统的。

与真实用户区分开来，这类用户的最大特点是安装系统后默认就会存在的，且默认情况不能登录系统，它们是系统正常运行必不可少的，他们的存在主要是方便系统管理，满足相应的系统进程都文件属主的要求。例如系统默认的bin、adm、nodoby、mail用户等。由于服务器角色的不同，有部分用不到的系统服务被禁止开机执行，因此，在做系统安全优化时，被禁止开机启动了的服务对应的虚拟用户也是可以处理掉的(删除或注释)。

**虚拟用户还可分为：**

* 系统程序用户

>
- 操作系统在安装时创建，用来运行系统服务，无root权限。
- 不可登录系统，没有`/home`目录及shell
- 系统用户UID一般从1到99，有些系统用户UID从500到900,像mysql为27，apache为48

* 服务程序用户

>
- 当安装某个服务后创建的用户，如安装SQL Server后，系统会创建对应的用户，运行SQL服务
- shell是`/sbin/nologin` or `/usr/sbin/nologin`, 用户不能登录
- 系统用户UID一般从100到999，nginx为992
- 如`useradd -s /sbin/nologin nginx` 或 `useradd -s /bin/false nginx`




### 用户和组的概念

我们知道，Linux是一个多用户多任务的分时操作系统，如果要使用系统资源，就必须向系统管理员申请一个账户，然后通过这个账户进入系统。这个账户和用户是一个概念，通过建立不同属性的用户，一方面，可以合理的利用和控制系统资源，另一方面也可以帮助用户组织文件，提供对用户文件的安全性保护。

每个用户都用一个唯一的用户名和用户口令，在登录系统时，只有正确输入了用户名和密码，才能进入系统和自己的主目录。

用户组是具有相同特征用户的逻辑集合，有时我们需要让多个用户具有相同的权限，比如查看、修改某一个文件的权限，一种方法是分别对多个用户进行文件访问授权，如果有10个用户的话，就需要授权10次，显然这种方法不太合理；另一种方法是建立一个组，让这个组具有查看、修改此文件的权限，然后将所有需要访问此文件的用户放入这个组中，那么所有用户就具有了和组一样的权限。这就是用户组，将用户分组是Linux 系统中对用户进行管理及控制访问权限的一种手段，通过定义用户组，在很大程度上简化了管理工作。　　
　　
### 用户和组的关系：

这里的用户和组的关系有点像数据库里面的关系，用户和用户组的对应关系有：一对一、一对多、多对一和多对多；下图展示了这种关系：

* **一对一**：即一个用户可以存在一个组中，也可以是组中的唯一成员。
* **一对多**：即一个用户可以存在多个用户组中。那么此用户具有多个组的共同权限。
* **多对一**：多个用户可以存在一个组中，这些用户具有和组相同的权限。
* **多对多**：多个用户可以存在多个组中。其实就是上面三个对应关系的扩展。


## 用户配置相关文件

* `/etc/passwd`: 系统用户配置文件，是用户管理中最重要的一个文件。这个文件记录了Linux系统中每个用户的一些基本属性，并且对所有用户可读。
> 现在许多Linux 版本都使用了shadow技术，把真正加密后的用户口令存放到/etc/shadow文件中，而在/etc/passwd文件的口令字段中只存放一个特殊的字符，例如用“x”或者“*”来表示。
* `/etc/shadow`: 用户影子文件，由于/etc/passwd文件是所有用户都可读的，这样就导致了用户的密码容易出现泄露，因此，linux将用户的密码信从/etc/passwd中分离出来，单独的放到了一个文件中，这个文件就是/etc/shadow，该文件只有root用户拥有读权限，从而保证了用户密码的安全性。
* `/etc/group`: 用户组配置文件，用户组的所有信息都存放在此文件中。
* `/etc/login.defs`: 用来定义创建一个用户时的默认设置，比如指定用户的UID和GID的范围，用户的过期时间、是否需要创建用户主目录等等。
* `/etc/default/useradd`: 当我们通过useradd命令不加任何参数创建一个用户后，用户默认的主目录一般位于/home下，默认使用的shell是/bin/bash，这是为什么呢，看看/etc/default/useradd这个文件的内容就完全明白了。
* `/etc/skel`: 在创建一个新用户后，会在新用户的主目录下看到类似`.bash_profile`, `.bashrc`, `.bash_logout`等文件，这些文件是怎么来的呢，如果我想让新建立的用户在主目录下默认拥有自己指定的配置文件，该如何设置呢？
/etc/skel目录就是解决这个问题的，`/etc/skel`目录定义了新建用户在主目录下默认的配置文件，更改`/etc/skel`目录下的内容就可以改变新建用户默认主目录的配置文件信息。

## 用户管理

### 添加、切换、删除用户组命令`groupadd`/`newgrp`/`groupdel`

* `groupadd`: 用来新建一个用户组。

	>
语法格式为：
	>
groupadd [-g -o] gid  group
	>
各个选项具体含义如下：
	>
	-g：指定新建用户组的GID号，该GID号必须唯一，不能和其它用户组的GID号重复。
	>
	-o：一般与-g选项同时使用，表示新用户组的GID可以与系统已有用户组的GID相同。

* `newgrp`: 用户可以在用户组之间切换

	>
如果一个用户同时属于多个用户组，那么用户可以在用户组之间切换，以便具有其他用户组的权限，newgrp主要用于在多个用户组之间进行切换，语法格式为：newgrp <用户组>


* `groupdel`: 表示删除用户组，语法格式为：groupdel [群组名称]

	>
当需要从系统上删除用户组时，可用groupdel指令来完成这项工作。如果该用户组中仍包括某些用户，则必须先删除这些用户后，然后才能删除用户组。

### 添加、修改和删除用户命令`useradd`/`usermod`/`userdel`

#### useradd建立用户的过程

`useradd`不加任何参数创建用户时，系统首先读取添加用户配置文件`/etc/login.defs`和`/etc/default/useradd`，根据这两个配置文件中定义的规则添加用户，然后会向`/etc/passwd`和`/etc/group`文件添加用户和用户组记录，同时`/etc/passwd`和`/etc/group`对应的加密文件也会自动生成记录，接着系统会自动在`/etc/default/useradd`文件设定的目录下建立用户主目录，最后复制`/etc/skel`目录中的所有文件到新用户的主目录中，这样一个新的用户就建立完成了。

* `useradd`: 创建用户 `--help`查看详情
	>
	命令：useradd +用户名，它不会在/home目录下创建同名文件夹，也没有创建密码，因此利用这个用户登录系统，是登录不了的；
	>
	命令：useradd -m +用户名，将在/home目录下创建同名文件夹，然后利用（passwd + 用户名）为指定的用户名设置密码。
	
	> 使用`passwd`给新添加的用户设置密码
	
	```
	-c　　:新账号passwd档的说明栏
	-d　　:新账号每次登录时所使用的home_dir，预设值为default_home内login名称，并当成登录时目录名称
	-e　　:账号终止日期，日期的指定格式为MM/DD/YY
	-g　　:group(组)名称或以数字来做用户登录的起始组。
	-G　　：定义此用户为多个不同groups的成员。每个用户组使用“，”逗号分隔即可
	-M　　：不建立用户家目录，优先于/etc/login.defs文件的设定。（一般创建虚拟用户时不建立家目录，部署服务时需要创建虚拟用户）
	-m　　:创建家目录
	-s　　：用户登录后使用的shell名称。（默认值不填写，这样系统会指定预设的登入shell（根据/etc/default/useradd 预设值））
	-u　　：*用户的ID值（这个值必须是唯一的，除非用（-o）选项。数字不可为负数）
	```
	
* `usermod`: 用来修改用户的账户属性信息
* `userdel`: 用来删除一个用户，若指定“-r”参数不但删除用户，同时删除用户的主目录以及目录下的所有文件

### 用户之间的切换`su`，`sudo`

#### 用户切换`su`

`su` substitute user，用于切换用户

`su - username`: 切换到username用户，需要输入密码

**不切换用户而直接执行命令：**
`su - root -c "ifconfig"`  需要输入密码

**`su` 和 `su -` 的区别**

`su -` ： 会切换root用户，也会把用户变量也切换到root的环境变量
`su` ：  只是会切换root用户，但是当前的环境变量还是以前用户的环境变量

#### 用户`sudo`

`sudo`（superuser do）命令用于以其他用户的身份执行特权命令

`sudo`命令用来以其他身份(默认身份为root)来执行命令，在`/etc/sudoers`中设置了可执行sudo指令的用户。

**`sudo`的运行的流程：**

1. 当用户运行sudo命令时，系统会主动寻找/etc/sudoers文件，判断该用户是否有执行sudo命令的权限;
2. 如果用户具有可执行sudo命令的权限，就让用户输入自己的password确认。
3. 若密码输入成功，则开始执行sudo后续的命令。

## 文件与权限的设定

所谓的文件权限，是指对文件的访问权限，包括对文件的读、写、删除、执行等，在linux下，每个用户都具有不同的权限，普通用户只能在自己的主目录下进行写操作，而在主目录之外，普通用户只能进行查找、读取操作，如何处理好文件权限和用户之间的关系，是本节讲述的重点。

### 查看文档详情
```
ls -l /var/log/nginx/error.log
-rw-r--r--. 1 root root 7769 Oct 31 02:22 /var/log/nginx/error.log
```

|-rw-r--r--. |  1 |  root |  root |  7769 | Oct 31 02:22 | /var/log/nginx/error.log |
| --- | --- | --- | --- | --- | --- | --- |
| 类型及权限 | 连结数 | 所属用户| 所属用户组 | 文档大小 | 最后修改时间 | 文档名称 |

### 利用`chown`改变属主和属组

`chown`就是`change owner`的意思，主要作用就是改变文件或者目录的所有者，而所有者包含用户和用户组，其实chown就是对文件所属的用户和用户组进行的一系列设置。

chown使用的一般语法为：

```
$chown [-R] 用户名称 文件或目录
$chown [-R] 用户名称:用户组组名称 文件或目录
　　参数说明：
　　-R : 进行递归式的权限更改，也就是将目录下的所有文件、子目录都更新成为指定的用户组权限。常常用于变更某一目录的情况。
　　注意，在执行操作前，确保指定的用户以及用户组在系统中是存在的。
```

### 利用`chmod`改变访问权限

`chmod`用于改变文件或目录的访问权限。该命令有两种用法。一种是包含字母和操作符表达式的字符设定法；另一种是包含数字的数字设定法。

使用语法为：`chmod [who] [+ | - | =] [mode] 文件名`

```
命令中各选项的含义如下：
　　who表示操作对象，可以是下面字母中的任何一个或者它们的组合。
　　u 表示“用户（user）”，即文件或目录的所有者。
　　g 表示“用户组（group）”，即文件或目录所属的用户组。
　　o 表示“其他（others）用户”。 
　　a 表示“所有（all）用户”。它是系统默认值。
　　操作符号含义如下：
　　“+”表示添加某个权限。
　　“-”表示取消某个权限。
　　“=”表示赋予给定的权限，同时取消文档以前的所有权限。
　　mode表示可以执行的权限，可以是“r“（只读）、“w”（可写）和“x”（可执行），以及它们的组合。
　　文件名可以是以空格分开的文件列表，支持通配符。
```
### chmod数字设定法

首先了解一下用数字表示属性的含义，0表示没有任何权限，1表示有可执行权限，与上面字符表示法中的“x”有相同的含义。2表示有可写权限，与“w”对应，4表示有可读权限，对应与“r“。

如果想让文件的属主拥有读和写的权限，可以通过4（可读）+2（可写）=6（可读可写）的方式来实现，那么用数字6就表示拥有读写权限。

例：

* `chmod 755  mysqltuner.pl`
* `chmod 400  tecentcloud_guangzhuo.pem`: 将证书文件更改为只读

摘自：[操作系统-多用户如何理解（Linux）](https://www.cnblogs.com/lemaden/p/10188848.html)